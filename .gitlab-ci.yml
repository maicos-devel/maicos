default:
  before_script:
  - apt-get update -q -y
  - apt-get -y install python3-dev python3-pip
  - pip3 install -r requirements.txt
  - export USE_CYTHON=True

stages:
  - test
  - deploy
  - release

.test:
  script:
    - pip3 install --upgrade pip setuptools wheel
    - python setup.py build_ext --inplace
    - pip3 install sphinx sphinx-press-theme
    - sphinx-build -b html docs/source public
    - pip3 install .
    - cd tests
    - pytest --disable-pytest-warnings .

test-3.6:
  extends: .test
  image: python:3.6
  stage: test

test-3.7:
  extends: .test
  image: python:3.7
  stage: test

test-3.8:
  extends: .test
  image: python:3.8
  stage: test

test-3.9:
  extends: .test
  image: python:3.9
  stage: test


deploy:
  image: python:3.9
  stage: deploy
  variables:
    TWINE_USERNAME: $PYPI_USERNAME
    TWINE_PASSWORD: $PYPI_PASSWORD
  script:
    - pip3 install twine
    - python3 setup.py sdist
    - twine upload dist/*
  only:
    - master

pages:
  image: python:3.9
  stage: release
  script:
  - python setup.py build_ext --inplace
  - sphinx-build -b html docs/source public
  artifacts:
    paths:
    - public
